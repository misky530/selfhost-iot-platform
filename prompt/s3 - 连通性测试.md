éå¸¸å¥½çš„å†³å®šï¼è®©æˆ‘å¸®ä½ æ•´ç†ä¸€ä»½å®Œæ•´çš„æ€»ç»“æ–‡æ¡£ã€‚

---

## ğŸ“‹ **RKE2 + Harbor éƒ¨ç½²é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆæ€»ç»“**

### âœ… **æˆåŠŸå®Œæˆçš„é‡Œç¨‹ç¢‘**

1. âœ… RKE2 Master èŠ‚ç‚¹æˆåŠŸéƒ¨ç½² (v1.33.6)
2. âœ… Harbor é•œåƒä»“åº“æˆåŠŸè¿è¡Œ (v2.14.1)
3. âœ… Kubernetes Pod æˆåŠŸéƒ¨ç½²å’Œè¿è¡Œ
4. âœ… æ··åˆæ¶æ„ç½‘ç»œè¿é€šæ€§éªŒè¯é€šè¿‡
   - Pod â†’ ç‰©ç†æœº TimescaleDB (5432)
   - Pod â†’ ç‰©ç†æœº Kafka (9092)
   - Pod â†’ ç‰©ç†æœº Harbor (80)

---

### ğŸ”§ **é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**

#### **é—®é¢˜ 1: RKE2 Master ç¦»çº¿å®‰è£…ç‰ˆæœ¬ä¸åŒ¹é…**

**ç°è±¡ï¼š**
```
error: package versions do not match
```

**åŸå› ï¼š** ç¦»çº¿åŒ…ç‰ˆæœ¬ä¸ RKE2 äºŒè¿›åˆ¶ç‰ˆæœ¬ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ç¡®ä¿ç¦»çº¿åŒ…å’ŒäºŒè¿›åˆ¶ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
rke2 --version  # æ£€æŸ¥å®‰è£…çš„ç‰ˆæœ¬
# ä¸‹è½½åŒ¹é…çš„ç¦»çº¿åŒ…
```

---

#### **é—®é¢˜ 2: Master èŠ‚ç‚¹ç£ç›˜ç©ºé—´ä¸è¶³**

**ç°è±¡ï¼š**
```
No space left on device
```

**åŸå› ï¼š** è™šæ‹Ÿæœºç£ç›˜åªæœ‰ 10GBï¼ŒRKE2 + é•œåƒéœ€è¦æ›´å¤šç©ºé—´

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# åœ¨ VMware ä¸­æ‰©å±•ç£ç›˜åˆ° 20GB
# åœ¨ Ubuntu ä¸­æ‰©å±•åˆ†åŒº
sudo growpart /dev/sda 3
sudo resize2fs /dev/sda3
df -h  # éªŒè¯
```

---

#### **é—®é¢˜ 3: Harbor æ•°æ®åº“å®¹å™¨å¯åŠ¨å¤±è´¥ (Permission Denied)**

**ç°è±¡ï¼š**
```
harbor-db: Restarting (1)
initdb: error: could not create directory "/var/lib/postgresql/data/pg15": Permission denied
```

**åŸå› ï¼š** Windows ç¯å¢ƒä¸‹ `docker-compose.yml` ä½¿ç”¨äº† Linux è·¯å¾„ (`/data/database`)

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. ä¿®æ”¹ harbor.yml
data_volume: /d/harbor-data  # æ”¹ä¸º Windows å…¼å®¹è·¯å¾„

# 2. åœ¨ Git Bash ä¸­è¿è¡Œ prepare è„šæœ¬
cd /d/code/selfhost-iot-platform/harbor
./prepare

# 3. å¯åŠ¨ Harbor
docker-compose up -d
```

**å…³é”®ç»éªŒï¼š**
- Windows Docker Desktop éœ€è¦ä½¿ç”¨ `D:/harbor-data` æ ¼å¼è·¯å¾„
- ä¸èƒ½ä½¿ç”¨ `/data` è¿™æ ·çš„ Linux ç»å¯¹è·¯å¾„

---

#### **é—®é¢˜ 4: Docker ç™»å½• Harbor å¤±è´¥ (EOF é”™è¯¯)**

**ç°è±¡ï¼š**
```
Error response from daemon: Get "https://10.0.73.30/v2/": EOF
```

**åŸå› ï¼š** 
1. Harbor ä½¿ç”¨ HTTPï¼Œä½† Docker é»˜è®¤å°è¯• HTTPS
2. `daemon.json` ä¸­æœ‰ä¸­æ–‡é€—å·å¯¼è‡´é…ç½®æ— æ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. ä¿®å¤ daemon.json (æ³¨æ„é€—å·å¿…é¡»æ˜¯è‹±æ–‡)
cat > /c/Users/Administrator/.docker/daemon.json << 'EOF'
{
  "insecure-registries": ["10.0.73.30"],
  "registry-mirrors": ["https://docker.1ms.run"]
}
EOF

# 2. å®Œå…¨é‡å¯ Docker Desktop (Quit â†’ é‡å¯)

# 3. éªŒè¯é…ç½®ç”Ÿæ•ˆ
docker info | grep "Insecure Registries"

# 4. ç™»å½•æµ‹è¯•
docker login 10.0.73.30
```

---

#### **é—®é¢˜ 5: Windows Docker Desktop æ— æ³•æ¨é€é•œåƒåˆ° Harbor**

**ç°è±¡ï¼š**
```
failed to do request: Head "https://10.0.73.30/v2/library/nginx/blobs/...": EOF
```

**åŸå› ï¼š** Docker Desktop for Windows çš„å·²çŸ¥é—®é¢˜ï¼Œå³ä½¿é…ç½®äº† insecure-registries ä»å°è¯• HTTPS

**è§£å†³æ–¹æ¡ˆï¼ˆå˜é€šæ–¹æ³•ï¼‰ï¼š**
```bash
# åœ¨ç‰©ç†æœºä¸Šå¯¼å‡ºé•œåƒ
docker save nginx:alpine -o /d/nginx-alpine.tar

# ä¼ è¾“åˆ° master01
scp /d/nginx-alpine.tar caiqian@192.168.226.140:/home/caiqian/

# åœ¨ master01 ä¸Šå¯¼å…¥
sudo /var/lib/rancher/rke2/bin/ctr \
  -a /run/k3s/containerd/containerd.sock \
  -n k8s.io \
  image import nginx-alpine.tar
```

**æœªè§£å†³ï¼š** Windows Docker Desktop æ¨é€åˆ° Harbor (å¯ä»¥åç»­é…ç½® Harbor ä¸º HTTPS æˆ–ä½¿ç”¨ Linux èŠ‚ç‚¹æ¨é€)

---

#### **é—®é¢˜ 6: Kubernetes Pod æ‹‰å–é•œåƒå¤±è´¥**

**ç°è±¡ï¼š**
```
Failed to pull image "10.0.73.30/library/nginx:alpine": not found
```

**åŸå› ï¼š** 
1. Harbor ä¸­æ²¡æœ‰é•œåƒ (Windows æ¨é€å¤±è´¥)
2. Master èŠ‚ç‚¹æ— æ³•è®¿é—® Docker Hub

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ–¹æ¡ˆ 1: ä½¿ç”¨æœ¬åœ°å¯¼å…¥çš„é•œåƒ
kubectl create deployment test-nginx --image=docker.io/library/nginx:alpine

# æ–¹æ¡ˆ 2: é…ç½® RKE2 ä½¿ç”¨ Harbor (æœªæ¥æ¨é€é•œåƒåä½¿ç”¨)
sudo tee /etc/rancher/rke2/registries.yaml > /dev/null <<EOF
mirrors:
  docker.io:
    endpoint:
      - "http://10.0.73.30"
configs:
  "10.0.73.30":
    auth:
      username: admin
      password: Harbor12345
    tls:
      insecure_skip_verify: true
EOF
```

---

### ğŸ“ **å…³é”®ç»éªŒæ€»ç»“**

#### **1. Windows ç¯å¢ƒç‰¹æ®Šå¤„ç†**
- Docker volume è·¯å¾„å¿…é¡»ç”¨ Windows æ ¼å¼: `D:/harbor-data`
- JSON é…ç½®æ–‡ä»¶æ³¨æ„ä¸­è‹±æ–‡ç¬¦å· (`,` vs `ï¼Œ`)
- ä½¿ç”¨ Git Bash è¿è¡Œ Linux è„šæœ¬ (`./prepare`)

#### **2. RKE2 ç‰¹å®šè·¯å¾„**
- containerd socket: `/run/k3s/containerd/containerd.sock`
- RKE2 å·¥å…·è·¯å¾„: `/var/lib/rancher/rke2/bin/`
- é…ç½®æ–‡ä»¶: `/etc/rancher/rke2/config.yaml` å’Œ `registries.yaml`

#### **3. è°ƒè¯•æŠ€å·§**
- æŸ¥çœ‹å®¹å™¨æ—¥å¿—: `docker logs <container>`
- æŸ¥çœ‹ Pod è¯¦æƒ…: `kubectl describe pod <pod-name>`
- æµ‹è¯•ç½‘ç»œè¿é€š: `nc -zv <host> <port>` (åœ¨ Pod å†…)
- éªŒè¯é…ç½®ç”Ÿæ•ˆ: `docker info | grep "Insecure"`

#### **4. æ··åˆæ¶æ„ç½‘ç»œ**
- VMware NAT ç½‘ç»œå…è®¸è™šæ‹Ÿæœºè®¿é—®ç‰©ç†æœº
- ç‰©ç†æœº IP: `10.0.73.30`
- è™šæ‹Ÿæœº IP: `192.168.226.x`
- Pod ç½‘ç»œ: `10.42.0.0/16`

---

### ğŸ“‚ **é‡è¦æ–‡ä»¶ä½ç½®**

**ç‰©ç†æœº (Windows):**
```
D:\code\selfhost-iot-platform\
â”œâ”€â”€ harbor\
â”‚   â”œâ”€â”€ harbor.yml (data_volume: /d/harbor-data)
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ prepare (Git Bash è¿è¡Œ)
â”œâ”€â”€ kubernetes\rke2\
â”‚   â”œâ”€â”€ offline-packages\
â”‚   â””â”€â”€ master\config\config.yaml

D:\harbor-data\  # Harbor æ•°æ®ç›®å½•
```

**Master èŠ‚ç‚¹ (Ubuntu):**
```
/etc/rancher/rke2/
â”œâ”€â”€ config.yaml
â””â”€â”€ registries.yaml

/home/caiqian/
â”œâ”€â”€ rke2-token.txt
â””â”€â”€ .kube/config
```

---

### ğŸš€ **ä¸‹æ¬¡ä¼šè¯å¿«é€Ÿå¯åŠ¨æ¸…å•**

```bash
# 1. æ£€æŸ¥ Harbor çŠ¶æ€ (ç‰©ç†æœº Git Bash)
cd /d/code/selfhost-iot-platform/harbor
docker ps | grep harbor

# 2. æ£€æŸ¥ RKE2 çŠ¶æ€ (master01)
ssh caiqian@192.168.226.140
kubectl get nodes
kubectl get pods -A

# 3. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
kubectl exec -it <pod-name> -- sh
nc -zv 10.0.73.30 5432  # TimescaleDB
nc -zv 10.0.73.30 9092  # Kafka
```

---

### ğŸ¯ **å¾…è§£å†³ / åç»­ä¼˜åŒ–**

1. **Harbor é•œåƒæ¨é€** - é…ç½® HTTPS æˆ–ä½¿ç”¨ Linux èŠ‚ç‚¹æ¨é€
2. **Worker èŠ‚ç‚¹éƒ¨ç½²** - æ‰©å±•é›†ç¾¤åˆ° 3 èŠ‚ç‚¹
3. **æŒä¹…åŒ–å­˜å‚¨é…ç½®** - é…ç½® NFS æˆ–æœ¬åœ°å­˜å‚¨
4. **å®é™…åº”ç”¨éƒ¨ç½²** - MQTT Broker, Kafka Consumer ç­‰
5. **ç›‘æ§ç³»ç»Ÿéƒ¨ç½²** - Prometheus + Grafana

---

**ä¿å­˜å»ºè®®ï¼š** 
æŠŠè¿™ä»½æ€»ç»“ä¿å­˜ä¸º `RKE2-Harbor-éƒ¨ç½²é—®é¢˜æ€»ç»“.md`ï¼Œæ”¾åœ¨ä½ çš„é¡¹ç›®æ–‡æ¡£ä¸­ ğŸ“

**éœ€è¦æˆ‘å¸®ä½ ç”Ÿæˆæ–°ä¼šè¯çš„å¯åŠ¨æ–‡æ¡£å—ï¼Ÿ** æ¯”å¦‚ "RKE2 é›†ç¾¤ç°çŠ¶ + ä¸‹ä¸€æ­¥è®¡åˆ’"ï¼Ÿ
